<!DOCTYPE html>
<html lang="zh-tw">
<meta name="viewport" content="width=device-width, initial-scale=1">

<head>
    <meta charset="utf-8">
    <title>會員管理</title>

    <!-- Latest compiled and minified CSS -->
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/4.5.0/css/bootstrap.min.css">

    <!-- jQuery library -->
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.6.4/jquery.min.js"></script>

    <!-- Popper JS -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.16.0/umd/popper.min.js"></script>

    <!-- Latest compiled JavaScript -->
    <script src="https://maxcdn.bootstrapcdn.com/bootstrap/4.5.0/js/bootstrap.min.js"></script>

    <!-- angular -->
    <script src="https://cdn.staticfile.org/angular.js/1.8.1/angular.min.js"></script>

    <!-- css-->
    <link rel="stylesheet" type="text/css" href="./css/basic.css">

    <!-- Date Picker -->
    <script src="https://www.itxst.com/package/bootstrap-datepicker-1.9.0/js/bootstrap-datepicker.min.js"></script>
    <script
        src="https://www.itxst.com/package/bootstrap-datepicker-1.9.0/locales/bootstrap-datepicker.zh-CN.min.js"></script>
    <link href="https://www.itxst.com/package/bootstrap-datepicker-1.9.0/css/bootstrap-datepicker.min.css"
        rel="stylesheet">




</head>

<body id="test">
    <h1>會員管理</h5>

        <!-- 導覽列 -->
        <nav class="navbar navbar-expand-sm  bg-light">

            <ul class="navbar-nav mr-8">

                <!-- 重新整理 -->
                <li class="nav-item">
                    <button type="button" class="btn btn-outline-primary" onclick="getAllData()">
                        搜尋所有
                    </button>
                </li>

                <!-- 新增 -->
                <li class="nav-item">
                    <button type="button" class="btn btn-outline-success" onclick="addButtonClick()">新增
                    </button>
                </li>

            </ul>

            <!-- 搜尋 -->
            <div class="collapse navbar-collapse justify-content-end">
                <form class="form-inline">
                    <input type="text" id="searchText" class="form-control mr-2" placeholder="請輸入會員身份證字號">
                    <button class="btn btn-outline-success" type="button" onclick="search()">搜尋</button>
                </form>
            </div>
        </nav>


        <!-- 列表 -->
        <div class="table-responsive">

            <table id="table" class="table table-bordered table-striped" cellspacing="0" width="90%">

                <tr>
                    <th>項次</th>
                    <th>mid</th>
                    <th>name</th>
                    <th>nationalId</th>
                    <th>username</th>
                    <th>刪除</th>
                    <th>編輯</th>
                </tr>

            </table>
        </div>

        </div>



        <!-- 新增/編輯 Modal -->
        <div class="modal fade" id="exampleModal" tabindex="-1" role="dialog" aria-labelledby="exampleModalLabel"
            aria-hidden="true">
            <div class="modal-dialog modal-lg" role="document">
                <div class="modal-content">

                    <div class="modal-header">
                        <h5 class="modal-title" id="editModalLabel">編輯會員資料</h5>
                        <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                            <span aria-hidden="true">&times;</span>
                        </button>
                    </div>

                    <!-- body -->
                    <div class="modal-body " style="height:500px;overflow:auto;">

                        <!-- mid -->
                        <div id="modalMidDiv" class="form-group">
                            <label for="midLabel">mid</label>
                            <input id="mid" placeholder="會員編號" class="form-control" type="text" readonly>
                        </div>

                        <!-- username -->
                        <div class="form-group">
                            <label for="usernameLabel">username</label>
                            <input id="username" placeholder="帳號" type="text" class="form-control">
                        </div>

                        <!-- password -->
                        <div class="form-group">
                            <label for="passwordLabel">password</label>
                            <input id="password" placeholder="密碼" type="text" class="form-control">
                        </div>

                        <!-- name -->
                        <div class="form-group">
                            <label for="nameLabel">name</label>
                            <input id="name" placeholder="姓名" type="text" class="form-control">
                        </div>

                        <!-- sex -->
                        <div class="form-group">
                            <label for="sexState">sex</label>
                            <select id="sex" class="form-control">
                                <option selected>請選擇</option>
                                <option>M</option>
                                <option>F</option>
                            </select>
                        </div>

                        <!-- nationalId -->
                        <div class="form-group">
                            <label for="nationalIdLabel">nationalId</label>
                            <input id="nationalId" placeholder="身份證字號" type="text" class="form-control">
                        </div>

                        <!-- birthDate -->
                        <!-- ref:
                        https://www.itxst.com/bootstrap-datepicker/tutorial.html#:~:text=bootstra,%E8%A6%81%E7%9A%84%E5%8A%9F%E8%83%BD%E5%92%8CUI%E3%80%82 
                        -->
                        <div class="form-group">
                            <label for="birthDateLabel">birthDate</label>
                            <input id="birthDate" placeholder="請選擇日期" type="text" class="form-control">
                        </div>

                        <!-- cellphone -->
                        <div class="form-group">
                            <label for="cellphoneLabel">cellphone</label>
                            <input id="cellphone" placeholder="手機" type="text" class="form-control">
                        </div>

                        <!-- landlineprefix -->
                        <div class="form-group">
                            <label for="landlineprefixLabel">landlineprefix</label>
                            <input id="landlineprefix" placeholder="市內電話區碼" type="text" class="form-control">
                        </div>

                        <!-- landline -->
                        <div class="form-group">
                            <label for="landlineLabel">landline</label>
                            <input id="landline" placeholder="市內電話" type="text" class="form-control">
                        </div>

                        <!-- mail -->
                        <div class="form-group">
                            <label for="mailTitle">email</label>
                            <input id="email" placeholder="電子信箱" type="email" class="form-control">
                        </div>

                        <!-- postalCode -->
                        <div class="form-group">
                            <label for="postalCodeLabel">postalCode</label>
                            <select id="postalCode" class="form-control">
                                <option selected>請選擇</option>
                                <option>100</option>
                                <option>200</option>
                            </select>
                        </div>

                        <!-- address -->
                        <div class="form-group">
                            <label for="addressTitle">address</label>
                            <input id="address" placeholder="地址" type="text" class="form-control">
                        </div>

                        <!-- footnote -->
                        <div class="form-group">
                            <label for="footnoteTitle">footnote</label>
                            <textarea id="footnote" placeholder="備註" class="form-control"
                                id="exampleFormControlTextarea1" rows="3"></textarea>
                        </div>



                    </div>

                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-dismiss="modal">取消</button>
                        <button type="button" class="btn btn-primary" onclick="updateOrAddButtonClick()">儲存</button>
                    </div>
                </div>
            </div>
        </div>



</body>



<script>

    var datas = [];

    //查詢所有
    function getAllData() {
        // 清除table
        $("#table").find("tr:gt(0)").remove();

        dataUrl = "http://localhost:8080/api/in/v1/members";
        $.ajax({
            method: 'get',
            url: dataUrl,
            crossDomain: true,
            type: "json",
            async: true,
            headers: {
                'Access-Control-Allow-Origin': '*',
                'Access-Control-Allow-Methods': 'GET, PUT, POST, DELETE, OPTIONS',
                'Access-Control-Allow-Headers': 'Access-Control-Allow-Headers, Access-Control-Allow-Origin, Origin, Content-Type, Authorization, Accept',
                'cache-control': 'no-cache'
            },
            success: getAllSuccess,
            error: function (jqXHR, thrownError) {
                let errorMsg = "jqXHR.status:" + jqXHR.status + "\n" + "message:" + thrownError;
                alert(errorMsg);
            }
        });

    }

    function getAllSuccess(data) {
        datas = data;
        updateTable(data);
    }



    // 編輯會員資訊
    function editButtonClick(mid) {
        dataUrl = "http://localhost:8080/api/in/v1/members/" + mid;
        $.ajax({
            method: 'get',
            url: dataUrl,
            crossDomain: true,
            type: "json",
            async: true,
            headers: {
                'Access-Control-Allow-Origin': '*',
                'Access-Control-Allow-Methods': 'GET, PUT, POST, DELETE, OPTIONS',
                'Access-Control-Allow-Headers': 'Access-Control-Allow-Headers, Access-Control-Allow-Origin, Origin, Content-Type, Authorization, Accept',
                'cache-control': 'no-cache'
            },
            success: findEditSuccessEdit,
            error: function (jqXHR, thrownError) {
                let errorMsg = "jqXHR.status:" + jqXHR.status + "\n" + "message:" + thrownError;
                alert(errorMsg);
            }
        });
    }

    // 取得特定會員資訊(編輯前先查詢)
    function findEditSuccessEdit(data) {
        // 更新Ui
        $("#editModalLabel").text("編輯會員資料");
        $("#modalMidDiv").show(true);
        $("#mid").val(data.mid);
        $("#username").val(data.username);
        $("#password").val(data.password);
        $("#name").val(data.name);
        $("#sex").val(data.sex);
        $("#nationalId").val(data.nationalId);
        $("#birthDate").val(data.birthDate);
        $("#cellphone").val(data.cellphone);
        $("#landlineprefix").val(data.landlineprefix);
        $("#landline").val(data.landline);
        $("#email").val(data.email);
        $("#postalCode").val(data.postalCode);
        $("#address").val(data.address);
        $("#footnote").val(data.footnote);
        $('#exampleModal').modal(show = true);
    }


    // 更新/增加 會員資料
    function updateOrAddButtonClick() {
        let mid = $("#mid").val();

        let isAdd = mid === "" ? true : false;

        let username = $("#username").val();
        let password = $("#password").val();
        let name = $("#name").val();
        let sex = $("#sex").val();
        let nationalId = $("#nationalId").val();
        let birthDate = $("#birthDate").val();
        let cellphone = $("#cellphone").val();
        let landlineprefix = $("#landlineprefix").val();
        let landline = $("#landline").val();
        let email = $("#email").val();
        let postalCode = $("#postalCode").val();
        let address = $("#address").val();
        let footnote = $("#footnote").val();


        var member = {};

        if (isAdd == false) {
            member.mid = parseInt(mid);
        }

        member.username = username;
        member.password = password;
        member.name = name;
        member.sex = sex;
        member.nationalId = nationalId;
        member.birthDate = birthDate;
        member.cellphone = cellphone;
        member.landlineprefix = landlineprefix;
        member.landline = landline;
        member.email = email;
        member.postalCode = parseInt(postalCode);
        member.address = address;
        member.footnote = footnote;

        //資料檢查 ~______~
        if (isAdd) {
            dataUrl = "http://localhost:8080/api/in/v1/members/add";
            $.ajax({
                method: 'post',
                url: dataUrl,
                crossDomain: true,
                contentType: 'application/json',
                async: true,
                headers: {
                    'Access-Control-Allow-Origin': '*',
                    'Access-Control-Allow-Methods': 'GET, PUT, POST, DELETE, OPTIONS',
                    'Access-Control-Allow-Headers': 'Access-Control-Allow-Headers, Access-Control-Allow-Origin, Origin, Content-Type, Authorization, Accept',
                    'cache-control': 'no-cache'
                },
                data: JSON.stringify(member),
                dataType: "json",
                success: addSuccess,
                error: function (jqXHR, thrownError) {
                    let errorMsg = "jqXHR.status:" + jqXHR.status + "\n" + "message:" + thrownError;
                    alert(errorMsg);
                }
            });
        }
        else {
            dataUrl = "http://localhost:8080/api/in/v1/members/" + mid;
            $.ajax({
                method: 'put',
                url: dataUrl,
                crossDomain: true,
                contentType: 'application/json',
                async: true,
                headers: {
                    'Access-Control-Allow-Origin': '*',
                    'Access-Control-Allow-Methods': 'GET, PUT, POST, DELETE, OPTIONS',
                    'Access-Control-Allow-Headers': 'Access-Control-Allow-Headers, Access-Control-Allow-Origin, Origin, Content-Type, Authorization, Accept',
                    'cache-control': 'no-cache'
                },
                data: JSON.stringify(member),
                dataType: "json",
                success: updateSuccess,
                error: function (jqXHR, thrownError) {
                    let errorMsg = "jqXHR.status:" + jqXHR.status + "\n" + "message:" + thrownError;
                    alert(errorMsg);
                }
            });

        }
    }

    function updateSuccess() {
        $('#exampleModal').modal(show = false);
        getAllData();
        alert("更新成功!");
    }

    function addSuccess() {
        $('#exampleModal').modal(show = false);
        alert("新增成功!");
        getAllData();
    }



    // 搜尋
    function search() {
        let searchText = $("#searchText").val();

        if (searchText.length === 0) {
            alert("請輸入查詢資訊");
            return
        }
        $("#table").find("tr:gt(0)").remove();
        let filterDatas = datas.filter(e => e.nationalId.includes(searchText));
        updateTable(filterDatas);
    }


    function delButtonClick(mid) {

        dataUrl = "http://localhost:8080/api/in/v1/members/" + mid;
        $.ajax({
            method: 'delete',
            url: dataUrl,
            crossDomain: true,
            async: true,
            headers: {
                'Access-Control-Allow-Origin': '*',
                'Access-Control-Allow-Methods': 'GET, PUT, POST, DELETE, OPTIONS',
                'Access-Control-Allow-Headers': 'Access-Control-Allow-Headers, Access-Control-Allow-Origin, Origin, Content-Type, Authorization, Accept',
                'cache-control': 'no-cache'
            },
            dataType: "json",
            success: function () {
                alert("刪除成功");
                getAllData();
            },
            error: function (jqXHR, thrownError) {
                let errorMsg = "jqXHR.status:" + jqXHR.status + "\n" + "message:" + thrownError;
                alert(errorMsg);
            }
        });

    }


    function addButtonClick() {

        $("#editModalLabel").text("新增會員資料");
        $("#modalMidDiv").hide(true);
        $("#mid").val("");
        $("#username").val("");
        $("#password").val("");
        $("#name").val("");
        $("#sex").val("請選擇");
        $("#nationalId").val("");
        $("#birthDate").val("");
        $("#cellphone").val("");
        $("#landlineprefix").val("");
        $("#landline").val("");
        $("#email").val("");
        $("#postalCode").val("請選擇");
        $("#address").val("");
        $("#footnote").val("");

        $('#exampleModal').modal(show = true);
    }

    // 基礎/初始化

    // 更新table
    function updateTable(datas) {
        $.each(datas, function (i) {
            var row = $("<tr></tr>");
            $("<td></td>").text(i + 1).appendTo(row);
            $("<td></td>").text(this.mid).appendTo(row);
            $("<td></td>").text(this.name).appendTo(row);
            $("<td></td>").text(this.nationalId).appendTo(row);
            $("<td></td>").text(this.username).appendTo(row);

            $("<td></td>").html("<input hidden=\'hidden\' id=\'delButton\' name=\'delButton\' />" +
                "<input type=\'button\' class=\'btn btn-danger\' value=\'刪除\' onclick=\'delButtonClick(" + this.mid + ")\'>").appendTo(row);
            $("#table").append(row);

            $("<td></td>").html("<input hidden=\'hidden\' id=\'editButton\' name=\'editButton\' />" +
                "<input type=\'button\' class=\'btn btn-warning\' value=\'編輯\' onclick=\'editButtonClick(" + this.mid + ")\'>").appendTo(row);
            $("#table").append(row);
        }
        );
    }

    $(document).ready(function () {
        getAllData();

        $("#birthDate").datepicker({
            language: 'zh-tw', //设置语言
            autoclose: true, //选择后自动关闭
            clearBtn: true,//清除按钮
            format: "yyyy-mm-dd"//日期格式
        });
    });

    function rs(data) {
        $("#main").html(data);
    }

    function redirect(url) {
        $.get(url, rs);
        return false;
    }

</script>

</html>